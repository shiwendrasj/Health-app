<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SehatPal - One Tap to Safety</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d32f2f">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.symbol.svg">

    <!-- QR Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.log('SW Registration Failed', err));
        }
    </script>
</head>

<body>

    <!-- Notification Toast -->
    <div id="toast" class="toast hidden"></div>

    <!-- MAIN CONTAINER -->
    <div class="app-container">

        <!-- Header / Nav -->
        <header class="main-header">
            <div class="logo-container" onclick="app.goHome()">
                <i class="ri-heart-pulse-fill logo-icon"></i>
                <h1 class="logo-text">SehatPal</h1>
            </div>
            <nav id="main-nav" class="hidden">
                <span id="user-greeting">Welcome</span>
                <button class="btn btn-sm btn-outline" onclick="auth.logout()">Sign Out</button>
            </nav>
        </header>

        <!-- VIEW: LANDING -->
        <section id="view-landing" class="view active">
            <div class="hero">
                <h2 class="hero-title">One Tap to Safety</h2>
                <p class="hero-subtitle">Reducing Golden-hour losses through accessible and empowering healthcare
                    innovation.</p>

                <div class="mode-selection">
                    <button class="btn btn-emergency" onclick="app.navigateTo('emergency')">
                        <i class="ri-alarm-warning-fill"></i>
                        Emergency Mode
                    </button>
                    <button class="btn btn-primary" onclick="app.navigateTo('auth')">
                        <i class="ri-hospital-line"></i>
                        OPD Mode
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW: AUTH (Login/Signup) -->
        <section id="view-auth" class="view hidden">
            <div class="auth-card">
                <div class="auth-tabs">
                    <button class="tab active" onclick="auth.switchTab('login')">Login</button>
                    <button class="tab" onclick="auth.switchTab('signup')">Sign Up</button>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="auth-form active" onsubmit="auth.handleLogin(event)">
                    <h3>OPD Access</h3>
                    <div class="input-group">
                        <label>User ID / Email</label>
                        <input type="text" id="login-id" required placeholder="Enter User ID">
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="login-pass" required placeholder="Enter Password">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Login</button>
                </form>

                <!-- Signup Form -->
                <form id="signup-form" class="auth-form hidden" onsubmit="auth.handleSignup(event)">
                    <h3>Create Account</h3>
                    <div class="input-group">
                        <label>Full Name</label>
                        <input type="text" id="signup-name" required placeholder="John Doe">
                    </div>
                    <div class="input-group">
                        <label>User ID / Email</label>
                        <input type="text" id="signup-id" required placeholder="Unique ID">
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="signup-pass" required placeholder="Create Password">
                    </div>
                    <!-- Detailed Initial Info for Emergency -->
                    <div class="input-group">
                        <label>Blood Group</label>
                        <select id="signup-blood" required>
                            <option value="">Select</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Emergency Contact</label>
                        <input type="tel" id="signup-contact" required placeholder="+91 9999999999">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Sign Up</button>
                </form>

                <button class="btn btn-text" onclick="app.goHome()">Back to Home</button>
            </div>
        </section>

        <!-- VIEW: EMERGENCY MODE -->
        <section id="view-emergency" class="view hidden emergency-theme">
            <div class="emergency-header">
                <button class="btn btn-sm btn-outline-white" onclick="app.goHome()"> <i class="ri-arrow-left-line"></i>
                    Back</button>
                <h2><i class="ri-alert-fill"></i> Emergency Mode</h2>
                <button class="btn btn-sm btn-outline-white" onclick="emergency.toggleMyQR()"> <i
                        class="ri-qr-code-line"></i> My QR</button>
            </div>

            <div class="emergency-content">
                <!-- Scanner State -->
                <div id="scanner-container" class="scanner-box">
                    <div id="reader"></div>
                    <p class="scan-instruction">Align QR code within the frame to scan patient details.</p>
                </div>

                <!-- Personal QR Display (Hidden by default) -->
                <div id="emergency-qr-container" class="scanner-box hidden">
                    <h3>My Emergency QR</h3>
                    <div id="emergency-qr-code" style="display: flex; justify-content: center; margin: 1rem 0;"></div>
                    <p class="small-text">Show this code to emergency responders.</p>
                </div>

                <!-- Result State (Hidden by default) -->
                <div id="patient-info-display" class="patient-card hidden">
                    <div class="patient-card-header">
                        <h3>Critical Patient Information</h3>
                        <span class="badge-critical">GOLDEN HOUR ACTIVE</span>
                    </div>

                    <div class="info-grid">
                        <div class="info-item">
                            <label>Name</label>
                            <strong id="display-name">--</strong>
                        </div>
                        <div class="info-item">
                            <label>Age</label>
                            <strong id="display-age">--</strong>
                        </div>
                        <div class="info-item highlight">
                            <label>Blood Group</label>
                            <strong id="display-blood">--</strong>
                        </div>
                    </div>

                    <div class="info-row">
                        <label>Medical Conditions</label>
                        <div id="display-conditions" class="tags-container">
                            <!-- Injected JS -->
                        </div>
                    </div>

                    <div class="info-row">
                        <label>Known Allergies</label>
                        <div id="display-allergies" class="tags-container">
                            <!-- Tags injected here -->
                        </div>
                    </div>

                    <div class="info-row">
                        <label>Emergency Contact</label>
                        <a href="#" id="display-contact-link" class="contact-btn">
                            <i class="ri-phone-fill"></i> <span id="display-contact">--</span>
                        </a>
                    </div>

                    <button class="btn btn-outline btn-block" onclick="emergency.resetScanner()">Scan Another</button>
                </div>
            </div>
        </section>

        <!-- VIEW: OPD DASHBOARD -->
        <section id="view-opd" class="view hidden opd-theme">
            <div class="dashboard-grid">

                <!-- Sidebar / Menu -->
                <aside class="dashboard-menu">
                    <button class="menu-item active" onclick="opd.switchTab('profile')"><i
                            class="ri-user-settings-line"></i> Profile & QR</button>
                    <button class="menu-item" onclick="opd.switchTab('records')"><i class="ri-file-list-3-line"></i>
                        Records</button>
                    <button class="menu-item" onclick="opd.switchTab('meds')"><i class="ri-capsule-line"></i>
                        Medications</button>
                    <button class="menu-item" onclick="opd.switchTab('appointments')"><i
                            class="ri-calendar-check-line"></i>
                        Appointments</button>
                </aside>

                <!-- Mobile Bottom Nav -->
                <nav class="mobile-nav">
                    <button class="nav-item active" onclick="opd.switchTab('profile')">
                        <i class="ri-user-settings-line"></i>
                        <span>Profile</span>
                    </button>
                    <button class="nav-item" onclick="opd.switchTab('records')">
                        <i class="ri-file-list-3-line"></i>
                        <span>Records</span>
                    </button>
                    <button class="nav-item" onclick="opd.switchTab('meds')">
                        <i class="ri-capsule-line"></i>
                        <span>Meds</span>
                    </button>
                    <button class="nav-item" onclick="opd.switchTab('appointments')">
                        <i class="ri-calendar-check-line"></i>
                        <span>Appts</span>
                    </button>
                </nav>

                <!-- Content Area -->
                <main class="dashboard-content">

                    <!-- Tab: Profile & QR -->
                    <div id="tab-profile" class="dashboard-tab active">
                        <h2>My Profile</h2>
                        <div class="profile-layout">
                            <!-- Edit Form -->
                            <div class="profile-form-container card">
                                <form id="profile-form" onsubmit="opd.saveProfile(event)">
                                    <div class="form-row">
                                        <div class="input-group">
                                            <label>Full Name</label>
                                            <input type="text" id="profile-name">
                                        </div>
                                        <div class="input-group">
                                            <label>Age</label>
                                            <input type="number" id="profile-age">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="input-group">
                                            <label>Blood Group</label>
                                            <select id="profile-blood">
                                                <option value="A+">A+</option>
                                                <option value="A-">A-</option>
                                                <option value="B+">B+</option>
                                                <option value="B-">B-</option>
                                                <option value="O+">O+</option>
                                                <option value="O-">O-</option>
                                                <option value="AB+">AB+</option>
                                                <option value="AB-">AB-</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label>Allergies (Comma separated)</label>
                                        <input type="text" id="profile-allergies" placeholder="Peanuts, Penicillin">
                                    </div>
                                    <div class="input-group">
                                        <label>Medical Conditions</label>
                                        <input type="text" id="profile-conditions" placeholder="Diabetes, Asthma">
                                    </div>
                                    <div class="input-group">
                                        <label>Emergency Contact</label>
                                        <input type="tel" id="profile-contact">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </form>
                            </div>

                            <!-- QR Display -->
                            <div class="qr-card card">
                                <h3>My Emergency QR</h3>
                                <div id="my-qr-code"></div>
                                <p class="small-text">Show this code to emergency responders.</p>
                                <button class="btn btn-sm btn-outline" onclick="opd.generateQR()">Refresh QR</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Records -->
                    <div id="tab-records" class="dashboard-tab hidden">
                        <div class="tab-header">
                            <h2>Medical Records</h2>
                            <button class="btn btn-sm btn-primary" onclick="opd.triggerUpload()">+ Upload Record <input
                                    type="file" id="file-upload" hidden onchange="opd.handleFileUpload(this)"></button>
                        </div>
                        <div class="card">
                            <ul id="records-list" class="item-list">
                                <!-- List items injected js -->
                                <li class="empty-state">No records found. Upload one!</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Tab: Medications -->
                    <div id="tab-meds" class="dashboard-tab hidden">
                        <div class="tab-header">
                            <h2>Current Medications</h2>
                            <button class="btn btn-sm btn-primary" onclick="opd.showAddMedModal()">+ Add
                                Medication</button>
                        </div>

                        <!-- Add Med Form (Simple Toggle) -->
                        <div id="add-med-form" class="card hidden mb-4">
                            <form onsubmit="opd.addMedication(event)">
                                <div class="form-row">
                                    <input type="text" id="med-name" placeholder="Medicine Name (e.g. Aspirin)" required
                                        class="input-flat">
                                    <input type="text" id="med-dose" placeholder="Dosage (e.g. 100mg)" required
                                        class="input-flat">
                                </div>
                                <button type="submit" class="btn btn-sm btn-primary mt-2">Add</button>
                            </form>
                        </div>

                        <div class="card">
                            <ul id="meds-list" class="item-list">
                                <!-- List items injected js -->
                                <li class="empty-state">No medications added.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Tab: Appointments (NEW) -->
                    <div id="tab-appointments" class="dashboard-tab hidden">
                        <div class="tab-header">
                            <h2>Appointments</h2>
                            <button class="btn btn-sm btn-primary" onclick="opd.toggleApptForm()">+ Book New</button>
                        </div>

                        <!-- Book Form -->
                        <div id="add-appt-form" class="card hidden mb-4">
                            <form id="appt-form" onsubmit="opd.bookAppointment(event)">
                                <div class="input-group">
                                    <label>Select Doctor</label>
                                    <select id="appt-doctor" required class="input-flat">
                                        <option value="">Choose...</option>
                                        <option value="Dr. Sharma (Cardiologist)">Dr. Sharma (Cardiologist)</option>
                                        <option value="Dr. Gupta (General)">Dr. Gupta (General)</option>
                                        <option value="Dr. Verma (Neurologist)">Dr. Verma (Neurologist)</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <div class="input-group">
                                        <label>Date</label>
                                        <input type="date" id="appt-date" required class="input-flat">
                                    </div>
                                    <div class="input-group">
                                        <label>Time</label>
                                        <input type="time" id="appt-time" required class="input-flat">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-sm btn-primary btn-block">Confirm Booking</button>
                            </form>
                        </div>

                        <div class="card">
                            <ul id="appt-list" class="item-list">
                                <!-- List items injected -->
                                <li class="empty-state">No upcoming appointments.</li>
                            </ul>
                        </div>
                    </div>

                </main>
            </div>
        </section>

    </div>

    <!-- SCRIPTS -->
    <!-- Firebase SDKs (Compat for easier integration) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="js/firebase-config.js"></script>
    <script src="js/db.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/emergency.js"></script>
    <script src="js/opd.js"></script>
    <script src="js/app.js"></script>
</body>

</html>